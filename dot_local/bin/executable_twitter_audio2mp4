#!/bin/sh

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if podman is installed
if ! command_exists podman; then
    echo "Error: podman is not installed. Please install podman and try again."
    exit 1
fi

# Check input arguments
if [ $# -eq 2 ]; then
    cover_image="$1"
    audio_file="$2"
elif [ $# -eq 1 ]; then
    cover_image=""
    audio_file="$1"
else
    echo "Usage: $0 [cover_image] <audio_file>"
    exit 1
fi

output_file="${audio_file%.*}_twitter.mp4"

# Run ffmpeg using podman
if [ -n "$cover_image" ]; then
    echo "Creating video from audio and cover image..."
    podman run --rm -v "$(pwd)":/tmp -w /tmp jrottenberg/ffmpeg \
        -loop 1 -i "$cover_image" -i "$audio_file" \
        -c:v libx264 -preset slow -crf 18 -pix_fmt yuv420p \
        -c:a aac -b:a 128k -shortest -movflags +faststart \
        "$output_file"
else
    echo "Creating video from audio with black background..."
    podman run --rm -v "$(pwd)":/tmp -w /tmp jrottenberg/ffmpeg \
        -f lavfi -i color=c=black:s=1280x720:r=1 -i "$audio_file" \
        -c:v libx264 -preset slow -crf 18 -pix_fmt yuv420p \
        -c:a aac -b:a 128k -shortest -movflags +faststart \
        "$output_file"
fi

if [ $? -eq 0 ]; then
    echo "Video creation complete. Output file: $output_file"
else
    echo "Error: Video creation failed."
    exit 1
fi
