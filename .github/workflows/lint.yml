name: Lint

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          ignore_paths: 'dot_emacs.d dot_zsh dot_local/bin'
          ignore_names: '*.zsh'

  shfmt:
    name: Shell Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shfmt
        run: |
          curl -sS https://webi.sh/shfmt | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Check shell formatting
        run: |
          shfmt -d -i 4 -ci run_once_*.sh run_onchange_*.sh || true

  elisp:
    name: Emacs Lisp
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Emacs
        run: |
          sudo apt-get update
          sudo apt-get install -y emacs-nox

      - name: Byte-compile elisp files
        run: |
          emacs --batch \
            --eval "(setq byte-compile-error-on-warn nil)" \
            --eval "(setq load-path (cons \"${{ github.workspace }}/dot_emacs.d/lisp\" load-path))" \
            -f batch-byte-compile dot_emacs.d/init.el dot_emacs.d/early-init.el || true

      - name: Check for common issues
        run: |
          echo "Checking for common elisp issues..."
          # Check for tabs (elisp convention is spaces)
          if grep -r $'\t' dot_emacs.d/*.el 2>/dev/null; then
            echo "Warning: Found tabs in elisp files (convention is spaces)"
          fi
          echo "Elisp check complete!"

  packages:
    name: Validate Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check packages.txt format
        run: |
          echo "Checking packages.txt..."
          # Check for empty lines between packages (comments allowed)
          # Check format: category/package
          grep -v '^#' packages.txt | grep -v '^$' | while read -r pkg; do
            if ! echo "$pkg" | grep -qE '^[a-z0-9-]+/[a-zA-Z0-9._-]+$'; then
              echo "Invalid package format: $pkg"
              exit 1
            fi
          done
          echo "All packages valid!"
